<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pohualli Calendar Converter</title>
<style>
body { font-family: system-ui, sans-serif; margin: 2rem; background:#fafafa; }
header { margin-bottom:1.5rem; }
form { margin-bottom:1.5rem; background:#fff; padding:1rem 1.25rem; border:1px solid #ccc; border-radius:8px; display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:1rem; }
label { display:block; margin:.2rem 0 .25rem; font-weight:600; }
input { padding:.4rem .6rem; font-size:1rem; width: 100%; }
button { padding:.55rem 1rem; font-size:1rem; cursor:pointer; }
.actions { grid-column: 1 / -1; }
.download { margin-left:.5rem; }
pre { background:#272822; color:#f8f8f2; padding:1rem; overflow:auto; border-radius:6px; }
.error { color:#b00020; font-weight:600; }
footer { margin-top:2rem; font-size:.85rem; color:#666; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:1rem; }
.card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:.75rem .9rem; }
.card h3 { margin:.1rem 0 .4rem; font-size:1rem; }
.value { font-family:monospace; }
</style>
<script>
function downloadJSON(){
  const pre = document.getElementById('rawjson');
  if(!pre) return;
  const blob = new Blob([pre.textContent], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pohualli_result.json';
  a.click();
}
async function runAutocorr(){
  const jdnField = document.getElementById('jdn');
  if(!jdnField.value){ alert('Enter JDN first then press Derive.'); return; }
  const params = new URLSearchParams();
  params.set('jdn', jdnField.value);
  const map = {
    tzolkin: 'ac_tz',
    haab: 'ac_h',
    g: 'ac_g',
    long_count: 'ac_lc',
    year_bearer: 'ac_yb',
    cycle819_station: 'ac_819s',
    cycle819_value: 'ac_819v',
    dir_color: 'ac_dc'
  };
  for(const [k,id] of Object.entries(map)){
    const v = document.getElementById(id).value.trim();
    if(v) params.set(k, v);
  }
  const pre = document.getElementById('ac_result');
  pre.style.display='block';
  pre.textContent='Calculating...';
  const resp = await fetch('/api/derive-autocorr?' + params.toString());
  if(resp.ok){
    const data = await resp.json();
    pre.textContent = JSON.stringify(data, null, 2);
  } else {
    pre.textContent = 'Error: ' + resp.status;
  }
}
</script>
</head>
<body>
<header>
  <h1>Pohualli Calendar Converter</h1>
  <p>Enter parameters to view composite Mesoamerican calendar data.</p>
</header>
<form method="get" action="/">
  <div>
    <label for="jdn">Julian Day Number</label>
    <input type="number" id="jdn" name="jdn" value="{{ comp.jdn if comp else '' }}" required />
  </div>
  <div>
    <label for="newEra">New Era (override)</label>
    <input type="number" id="newEra" name="new_era" value="{{ new_era if new_era is not none else '' }}" />
  </div>
  <div>
    <label for="preset">Correlation Preset</label>
    <select id="preset" name="preset">
      <option value="">(none)</option>
      {% for p in presets %}
        <option value="{{ p.name }}" {% if active_preset == p.name %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="ybm">Year Bearer Month</label>
    <input type="number" id="ybm" name="ybm" min="0" max="18" value="{{ ybm if ybm is not none else '' }}" />
  </div>
  <div>
    <label for="ybd">Year Bearer Day</label>
    <input type="number" id="ybd" name="ybd" min="0" max="19" value="{{ ybd if ybd is not none else '' }}" />
  </div>
  <div class="actions">
    <button type="submit">Convert</button>
    {% if comp %}<button class="download" type="button" onclick="downloadJSON()">Download JSON</button>{% endif %}
  </div>
</form>
<details style="margin-bottom:1.25rem; background:#fff; padding:1rem 1.25rem; border:1px solid #ccc; border-radius:8px;">
  <summary style="font-weight:600; cursor:pointer;">Corrections & Offsets</summary>
  <form method="get" action="/" style="margin-top:.8rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.75rem;">
    <input type="hidden" name="jdn" value="{{ comp.jdn if comp else '' }}" />
    <label>Tzolkin Num Off<input type="number" name="tz_off" value="{{ corr.tzolkin }}" /></label>
    <label>Tzolkin Name Off<input type="number" name="tzn_off" value="{{ corr.tzolkin_name }}" /></label>
    <label>Haab Off<input type="number" name="haab_off" value="{{ corr.haab }}" /></label>
    <label>G Off<input type="number" name="g_off" value="{{ corr.g }}" /></label>
    <label>LCD Off<input type="number" name="lcd_off" value="{{ corr.lcd }}" /></label>
    <label>Week Off<input type="number" name="week_off" value="{{ corr.week }}" /></label>
    <label>819 Station Off<input type="number" name="c819s" value="{{ corr.c819_station }}" /></label>
    <label>819 Dir/Color Off<input type="number" name="c819d" value="{{ corr.c819_dir }}" /></label>
    <div style="grid-column:1/-1;">
      <button type="submit">Apply Corrections</button>
    </div>
  </form>
</details>
<section style="margin-bottom:1.5rem; background:#fff; padding:1rem 1.25rem; border:1px solid #ccc; border-radius:8px;">
  <h2 style="margin-top:0">Derive Auto-Corrections</h2>
  <p style="margin-top:.25rem; font-size:.9rem; color:#444;">Provide any known calendar expressions for this JDN and fetch suggested correction offsets.</p>
  <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:.6rem;">
    <label style="font-weight:500;">Tzolkin<br><input id="ac_tz" placeholder="e.g. 11 Ik" /></label>
    <label style="font-weight:500;">Haab<br><input id="ac_h" placeholder="e.g. 0 Pop" /></label>
    <label style="font-weight:500;">G (0-8)<br><input id="ac_g" type="number" min="0" max="8" /></label>
    <label style="font-weight:500;">Long Count<br><input id="ac_lc" placeholder="13.0.0.0.0" /></label>
    <label style="font-weight:500;">Year Bearer<br><input id="ac_yb" placeholder="9 Ix" /></label>
    <label style="font-weight:500;">819 Station<br><input id="ac_819s" type="number" /></label>
    <label style="font-weight:500;">819 Value<br><input id="ac_819v" type="number" /></label>
    <label style="font-weight:500;">Dir Color<br><input id="ac_dc" placeholder="Este Rojo" /></label>
  </div>
  <div style="margin-top:.75rem;">
    <button type="button" onclick="runAutocorr()">Derive Offsets</button>
  </div>
  <pre id="ac_result" style="display:none; margin-top:1rem;"></pre>
</section>
{% if error %}<div class="error">Error: {{ error }}</div>{% endif %}
{% if comp %}
<section>
  <h2>Results</h2>
  <div class="grid">
    <div class="card"><h3>Tzolkin</h3><div class="value">{{ comp.tzolkin_value }} {{ comp.tzolkin_name }}</div></div>
    <div class="card"><h3>Haab</h3><div class="value">{{ comp.haab_day }} {{ comp.haab_month_name }}</div></div>
    <div class="card"><h3>Long Count</h3><div class="value">{{ comp.long_count }}</div></div>
    <div class="card"><h3>Year Bearer</h3><div class="value">0x{{ '%04X' % comp.year_bearer_packed }}</div></div>
    <div class="card"><h3>819 Cycle</h3><div class="value">Station {{ comp.cycle819_station }} / {{ comp.cycle819_value }}</div></div>
    <div class="card"><h3>Dir Color</h3><div class="value">{{ comp.dir_color_str }}</div></div>
    <div class="card"><h3>Mercury</h3><div class="value">{{ '%.2f' % comp.mercury_synodic }} ({{ comp.mercury_index }})</div></div>
    <div class="card"><h3>Venus</h3><div class="value">{{ '%.2f' % comp.venus_synodic }} ({{ comp.venus_index }})</div></div>
  <div class="card"><h3>Mars</h3><div class="value">{{ '%.2f' % comp.mars_synodic }} ({{ comp.mars_index }})</div></div>
  <div class="card"><h3>Jupiter</h3><div class="value">{{ '%.2f' % comp.jupiter_synodic }} ({{ comp.jupiter_index }})</div></div>
  <div class="card"><h3>Saturn</h3><div class="value">{{ '%.2f' % comp.saturn_synodic }} ({{ comp.saturn_index }})</div></div>
  <div class="card"><h3>Uranus</h3><div class="value">{{ '%.2f' % comp.uranus_synodic }} ({{ comp.uranus_index }})</div></div>
  <div class="card"><h3>Neptune</h3><div class="value">{{ '%.2f' % comp.neptune_synodic }} ({{ comp.neptune_index }})</div></div>
  <div class="card"><h3>Pluto</h3><div class="value">{{ '%.2f' % comp.pluto_synodic }} ({{ comp.pluto_index }})</div></div>
    <div class="card"><h3>Maya Moon</h3><div class="value">{{ '%.2f' % comp.maya_moon_age }}</div></div>
    <div class="card"><h3>Abn Dist</h3><div class="value">{{ '%.2f' % comp.abnormal_distance }}</div></div>
    <div class="card"><h3>Eclipse?</h3><div class="value">{{ 'Yes' if comp.eclipse_possible else 'No' }}</div></div>
    <div class="card"><h3>Star Zodiac</h3><div class="value">{{ comp.star_zodiac_deg }}° {{ comp.star_zodiac_name }}</div></div>
    <div class="card"><h3>Earth Zodiac</h3><div class="value">{{ comp.earth_zodiac_deg }}° {{ comp.earth_zodiac_name }}</div></div>
  </div>
  <h3>Raw JSON</h3>
  <pre id="rawjson">{{ comp | tojson(indent=2) }}</pre>
</section>
{% endif %}
<footer>Generated by Pohualli Python port.</footer>
</body>
</html>

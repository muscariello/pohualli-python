# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/) and this project (for now) follows simple semantic versioning (MAJOR.MINOR.PATCH).

## [0.3.0] - 2025-09-05
### Added
- Asynchronous range search job system (`/api/range-jobs`): create, poll, list, cancel; includes progress (scanned, total, elapsed) and partial result delivery.
- CLI `search-range` command with multi-filter support (tzolkin value/name, haab day/month, year bearer name, dir/color substring, weekday, Long Count pattern with `*` wildcards) plus performance diagnostics (`--progress-every`, `--perf-stats`, `--step`, `--limit`).
- Direction/color & 819‑cycle correction derivation support through `/api/derive-autocorr` and CLI `derive-autocorr` (station, value, dir_color).
- Extensive documentation for range search (README structure update and `docs/usage/cli.md` expanded section) including examples and performance tips.
- Additional test suites: async job internals, filter matrix, early filter branch coverage for CLI, widening long-count failure paths, direction/color invalid spec handling, deep template rendering scenarios.
- Environment throttle (`POHUALLI_RANGE_THROTTLE`) to aid deterministic cancellation timing in tests.

### Changed
- Homepage template enhanced to surface combined single-date conversion and inline range search results with customizable fields.
- Refined derive-autocorr logging for value errors (structured context) and unified JSON error responses (400 vs 500 separation).
- README structure tree updated to reflect new modules & expanded test coverage; CLI and quickstart docs augmented with search-range examples.

### Fixed
- Cancellation semantics: ensure endpoint sets status to `canceled` promptly for partial results without waiting for loop termination.
- Robust CLI output when zero matches or mismatched Long Count segment lengths (prints `# no matches` instead of partial headers or errors).
- Minor template resilience for invalid numeric range inputs (graceful error messaging instead of exception).

### Internal
- Coverage configuration updated to include thread concurrency; added large set of targeted tests (total count now 120+). Overall coverage still below historic baseline (approx. 65% vs prior 95%) due to newly added asynchronous and CLI scanning logic; follow-up tasks noted below.
- Substitution of subprocess-based CLI tests with direct `main()` invocation to avoid coverage loss.
- Added negative and widening-window test cases for long count correction search logic.

### Follow-up / TODO
- Raise coverage of `webapp.py` async loop & `cli.py` range loop branches (currently most uncovered lines).
- Consider extracting range filtering logic into pure functions for easier unit-level coverage.
- Potential performance optimization: batch composite computations when step > 1 or when filter set minimal.

### Migration Notes
No breaking API changes; new features are additive. Users can begin using `pohualli search-range` immediately after upgrade. Existing scripts relying on previous CLI commands unaffected.

---

## [0.2.5] - 2025-09-04
### Added
- _TBD_

### Changed
- _TBD_

### Fixed
- _TBD_

### Internal
- Prepare release scaffolding.

## [0.2.4] - 2025-09-04
### Added
- Desktop bundle workflow (macOS & Windows) producing release assets (ZIP + MSI) with automated upload on tagged releases.
- Installation documentation for desktop bundles (README, `docs/usage/desktop.md`, quickstart updates).
- `__main__.py` entry point enabling `python -m pohualli` and smoother bundled execution.

### Changed
- README install section expanded (PyPI vs desktop vs source) and structure tree updated with `__main__.py`.

### Internal
- Version bump to align PyPI/package metadata and desktop Briefcase config.


## [0.2.3] - 2025-09-04
### Added
- PyPI badge and direct package link in README.
- Expanded README file tree with per-file descriptions and docs sub-tree.
- ResearchGate link for scholarly reference.

### Changed
- README reorganized (highlights, consolidated structure, clarified install section).

### Internal
- Documentation-only release; no functional code changes.

## [0.2.2] - 2025-09-04
### Fixed

### Internal

## [0.2.1] - 2025-09-04
### Added
- Added scholarly citation (Sołtysiak & Lebeuf 2011) to README and calendars concepts page.

### Changed
- Converted bare reference URLs in documentation to markdown links for clickability.

### Fixed
- Documentation references in rendered site were not clickable (wrapped in proper link syntax).

### Internal
- Version bump preparing PyPI / tag release.

## [0.2.0] - 2025-09-04
### Added
- Continuous Integration workflow (`ci.yml`) running tests across Python 3.10–3.13.
- Coverage reporting via `pytest-cov` and Codecov upload + badge.
- Automated release workflow (`release.yml`): tag validation, build, PyPI publish, attestations, hash printing, GitHub Release with autogenerated notes.
- Docker multi-arch build workflow (amd64/arm64) (earlier iteration, retained).
- Year bearer human-readable display (adds unpacked name) in composite result and UI.
- Local storage persistence for correction inputs; Reset and Defaults actions in web UI.
- Dark / light theme toggle with stored preference; improved styling for readability.
- MkDocs documentation site (Material theme) with conceptual pages (calendars, configuration, CLI, API stub) and extended 819‑day cycle explanation.
- Added scholarly references including Sołtysiak & Lebeuf (2011) and anchor-linked Wikipedia sections for 819‑day count and Year Bearer.
- Added CODEOWNERS file.
- Added SPDX headers (GPL-3.0-only) to all source files.

### Changed
- Project license switched from MIT (early draft) to GPL-3.0-only; updated `LICENSE`, SPDX tags, and pyproject metadata.
- Packaging metadata enhanced: keywords, classifiers, project URLs, README as long description, coverage config.
- `pyproject.toml` license field modernized to SPDX string; removed deprecated license classifier to silence build warnings.

### Fixed
- Template issue where extraneous CSS appeared (duplicate `</style>` removal).
- Optional query parameter parsing (avoided validation errors by manual conversion path earlier in cycle).

### Documentation
- Expanded 819‑day cycle rationale (directional colors, planetary synodic alignment discussion, references).
- Added Year Bearer anchor reference and general Mesoamerican calendar references.
- Added README references section and link to CHANGELOG.

### CI / Release
- Artifact upload restricted to pushes on `main` or tags.
- Tag-to-version guard ensures release tag matches `pyproject.toml` version.
- Added attestation & hash printing for PyPI publish step.

### Internal / Dev
- Coverage configuration (`tool.coverage.*`) added to `pyproject.toml`.

## [0.1.0] - 2025-08-??
### Added
- Initial Python port structure (`pohualli` package) with core calendrical computations (Tzolk'in, Haab, Long Count, 819‑day cycle, moon heuristics, planetary synodic values, zodiac logic, year bearer packing) and CLI.
- Basic FastAPI web UI with index template.
- Initial test suite covering composite, cycle, moon/zodiac, CLI, etc.

### Notes
- Early exploratory release prior to enhanced documentation, CI, and packaging metadata.

---

## Future
- Potential: auto-generated API docs (mkdocstrings), richer planetary cycle documentation, enhanced test coverage for lower-covered modules (`autocorr`, `zodiac`, `webapp`).

[0.2.0]: https://github.com/muscariello/pohualli-python/releases/tag/v0.2.0
[0.1.0]: https://github.com/muscariello/pohualli-python/releases/tag/v0.1.0
[0.2.1]: https://github.com/muscariello/pohualli-python/releases/tag/v0.2.1
[0.2.2]: https://github.com/muscariello/pohualli-python/releases/tag/v0.2.2
[0.2.3]: https://github.com/muscariello/pohualli-python/releases/tag/v0.2.3
[0.2.4]: https://github.com/muscariello/pohualli-python/releases/tag/v0.2.4
